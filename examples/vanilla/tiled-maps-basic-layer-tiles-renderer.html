<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        height: 100vh;
        overflow-y: hidden;
      }
      body {
        color: #fff;
        background: linear-gradient(
          to right bottom,
          #0d1d3a 0,
          #1a2f55 52%,
          #365a83
        );
        font-family: sans-serif;
        font-size: 16px;
        line-height: 1.5;
      }
      .intro {
        font-family: "Arial Black", sans-serif;
        font-size: 24px;
      }
      em {
        font-family: Arial, sans-serif;
        font-size: 84.615384%;
        color: rgba(174, 221, 255, 0.8);
      }
      code {
        font-family: "Courier New", monospace;
        font-style: normal;
        font-size: 120%;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "@spearwolf/eventize": "/examples/vanilla/libs/eventize.js",
          "three": "/examples/vanilla/libs/three/build/three.module.js",
          "three/examples/jsm/controls/OrbitControls.js": "/examples/vanilla/libs/three/examples/jsm/controls/OrbitControls.js",
          "@spearwolf/vertex-objects": "/packages/vertex-objects/build/vertex-objects.js",
          "@spearwolf/display3": "/packages/display3/build/display3.js",
          "@spearwolf/tiled-maps": "/packages/tiled-maps/build/tiled-maps.js"
        }
      }
    </script>
  </head>
  <body>
    <section class="intro">
      <p>
        tiled-maps :: map2d-layer<br />
        <em>a <code>Map2DLayer3D/Map2DTileSpritesRenderer</code> example</em>
      </p>
    </section>
    <canvas id="canvas-container" resize-to="window"></canvas>
    <script type="module">
      import {
        BoxGeometry,
        EdgesGeometry,
        LineSegments,
        LineBasicMaterial,
      } from "three";
      import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";
      import { TextureFactory, TileSetLoader } from "@spearwolf/vertex-objects";
      import {
        RepeatingTilesProvider,
        Map2DLayer3D,
        Map2DTileSprites,
        RectangularVisibilityArea,
        TileSpritesGeometry,
        TileSpritesMaterial,
      } from "@spearwolf/tiled-maps";
      import { PerspectiveOrbitDemo } from "/examples/vanilla/jsm/display/PerspectiveOrbitDemo.js";
      import { makePoints } from "/examples/vanilla/jsm/utils/makePoints.js";

      const demo = new PerspectiveOrbitDemo(
        document.getElementById("canvas-container"),
        { antialias: false }
      );

      demo.start(async ({ scene, camera, width, height }) => {
        camera.position.set(0, 350, 500);
        camera.far = 8000;

        const geometry = new BoxGeometry(640, 20, 480);
        const edges = new EdgesGeometry(geometry);
        const line = new LineSegments(
          edges,
          new LineBasicMaterial({ color: 0xf0f0f0 })
        );
        scene.add(line);

        // create a map2d layer and add to scene
        // ------------------------------------------------------

        const map2dLayer = new Map2DLayer3D();

        map2dLayer.tileWidth = 256;
        map2dLayer.tileHeight = 256;
        map2dLayer.xOffset = -128;
        map2dLayer.yOffset = -128;

        map2dLayer.visibilitor = new RectangularVisibilityArea(640, 480);

        map2dLayer.centerX = 0;
        map2dLayer.centerY = 0;

        scene.add(map2dLayer);

        // demo.on("frame", () => map2dLayer.update());

        window.map2dLayer = map2dLayer;
        console.log("map2dLayer", map2dLayer);

        // create a tile data provider
        // ------------------------------------------------------

        const tileData = new RepeatingTilesProvider([
          [1, 2],
          [3, 4],
        ]);

        // load a tileset texture
        // ------------------------------------------------------

        const { tileSet, texture } = await new TileSetLoader().loadAsync(
          "/examples/assets/map2d-debug-tiles_4x256x256.png",
          {
            tileWidth: 256,
            tileHeight: 256,
          }
        );

        // create the tile-renderer and add to map2d-layer
        // ------------------------------------------------------

        const renderer = new Map2DTileSprites();

        map2dLayer.add(renderer);

        map2dLayer.addTileRenderer(renderer);

        renderer.tileData = tileData;
        renderer.tileSet = tileSet;

        renderer.geometry = new TileSpritesGeometry(1000);

        renderer.material = new TileSpritesMaterial({
          colorMap: texture,
          depthTest: true,
          depthWrite: true,
        });

        window.tileRenderer = renderer;
        console.log("tileRenderer", renderer);

        map2dLayer.update();

        // prettier-ignore
        scene.add(makePoints([
          -384, 11, -384,
          -128, 11, -384,
          128, 11, -384,
          384, 11, -384,

          -384, 11, -128,
          -128, 11, -128,
          128, 11, -128,
          384, 11, -128,

          -384, 11, 128,
          -128, 11, 128,
          128, 11, 128,
          384, 11, 128,

          -384, 11, 384,
          -128, 11, 384,
          128, 11, 384,
          384, 11, 384,
        ]));
      });
    </script>
  </body>
</html>
