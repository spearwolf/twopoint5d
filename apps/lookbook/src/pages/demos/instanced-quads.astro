---
import Layout from '~layouts/VanillaDemo.astro';
import {description, showSource, title} from './_instanced-quads.json';
---

<Layout title={title} showSource={showSource}>
  <p slot="demo-description">{description}</p>

  <canvas id="canvas-container" resize-to="window"></canvas>
</Layout>

<style>
  body {
    height: 100vh;
    overflow-y: hidden;
  }
  body {
    background-color: #391e39;
    background: radial-gradient(circle, rgba(189, 70, 98, 1) 0%, rgba(37, 4, 73, 1) 100%);
  }
</style>

<script>
  import {InstancedVertexObjectGeometry, VertexObjects, type VO} from '@spearwolf/twopoint5d';
  import {add, attribute, mul, vec3, vec4} from 'three/tsl';
  import {NodeMaterial} from 'three/webgpu';
  import {PerspectiveOrbitDemo} from '~demos/utils/PerspectiveOrbitDemo';

  // +================================================================================+
  //
  // base quad
  //
  // +================================================================================+

  interface BaseQuad extends VO {
    setPosition(position: [number, number, number, number, number, number, number, number, number, number, number, number]): void;
  }

  class BaseQuad {
    make(width = 0.5, height = 0.5) {
      this.setPosition([-width, -height, 0, -width, +height, 0, +width, +height, 0, +width, -height, 0]);
    }
  }

  const BaseQuadDescriptor = {
    vertexCount: 4,
    indices: [0, 2, 1, 0, 3, 2],

    attributes: {
      position: {components: ['x', 'y', 'z']},
    },

    basePrototype: BaseQuad.prototype,
  };

  // +================================================================================+
  //
  // instanced quad
  //
  // +================================================================================+

  interface InstancedQuad extends VO {
    width: number;
    height: number;

    setInstancePosition: (position: [number, number]) => void;
  }

  const InstancedQuadDescriptor = {
    meshCount: 1,

    attributes: {
      quadSize: {components: ['width', 'height']},
      instancePosition: {components: ['x', 'y', 'z']},
    },
  };

  // +================================================================================+
  //
  // create instanced geometry and mesh
  //
  // +================================================================================+

  function createMesh(rows: number, columns: number, size: number, offset: number) {
    const capacity = rows * columns;

    const geometry = new InstancedVertexObjectGeometry<InstancedQuad, BaseQuad>(
      InstancedQuadDescriptor,
      capacity,
      BaseQuadDescriptor,
    );

    // Create a base quad to use as a prototype for instanced quads
    geometry.basePool.createVO().make();

    // Now, create the instanced quads ..
    for (let y = 0; y < rows; y++) {
      for (let x = 0; x < columns; x++) {
        const cross = geometry.instancedPool.createVO();

        cross.width = 1.0 + Math.random() * (size - 1.0);
        cross.height = 1.0 + Math.random() * (size - 1.0);

        cross.setInstancePosition([
          x * size * offset - ((columns - 1) * size * offset) / 2,
          y * size * offset - ((rows - 1) * size * offset) / 2,
        ]);
      }
    }

    const mesh = new VertexObjects(geometry, createMaterial());
    mesh.name = 'InstancedQuadsMesh';

    return mesh;
  }

  // +================================================================================+
  //
  // create material
  //
  // +================================================================================+

  function createMaterial() {
    const material = new NodeMaterial();

    const position = attribute('position');
    const quadSize = attribute('quadSize');
    const instancePosition = attribute('instancePosition');

    material.positionNode = add(mul(position, vec3(quadSize, 1.0)), instancePosition);

    material.colorNode = vec4(1.0, 0.3, 0.6, 0.9);

    return material;
  }

  // +================================================================================+
  //
  // start demo
  //
  // +================================================================================+

  const demo = new PerspectiveOrbitDemo(document.getElementById('canvas-container'));

  await demo.start(() => {
    demo.scene.add(createMesh(10, 20, 3.2, 1.2));
  });

  console.log('InstancedQuadsMesh', demo.scene.children[0]);
</script>
